<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>éŸ³ã®ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ä½“é¨“ã‚¢ãƒ—ãƒªï¼ˆp5.jsç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/addons/p5.sound.min.js"></script>
  </head>
  <body>
    <main style="text-align:center;">
      <h2>ğŸ§ éŸ³ã®ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ä½“é¨“</h2>
      <p>éŒ²éŸ³ã¾ãŸã¯ã‚µãƒ³ãƒ—ãƒ«éŸ³ã‚’ä½¿ã£ã¦ã€æ¨™æœ¬åŒ–ã¨é‡å­åŒ–ã®å½±éŸ¿ã‚’ä½“é¨“ã—ã‚ˆã†ã€‚</p>

      <button id="recordBtn">ğŸ™ï¸ éŒ²éŸ³é–‹å§‹</button>
      <button id="playSampleBtn">â–¶ ã‚µãƒ³ãƒ—ãƒ«éŸ³å†ç”Ÿ</button>
      <br><br>

      <label>æ¨™æœ¬åŒ–é–“éš”ï¼ˆç²—ãã™ã‚‹ã¨éŸ³ãŒåŠ£åŒ–ï¼‰ï¼š</label><br />
      <input type="range" id="sampleSlider" min="1" max="20" value="1" />
      <span id="sampleValue">1</span><br /><br />

      <label>é‡å­åŒ–ãƒ“ãƒƒãƒˆæ•°ï¼ˆå°ã•ã„ã»ã©éŸ³ãŒåŠ£åŒ–ï¼‰ï¼š</label><br />
      <input type="range" id="bitSlider" min="2" max="16" value="8" />
      <span id="bitValue">8</span><br /><br />

      <audio id="playback" controls></audio>
    </main>

    <script>
      let mic, recorder, soundFile;
      let isRecording = false;
      let sampleSlider, bitSlider;

      function setup() {
        noCanvas();
        sampleSlider = select('#sampleSlider');
        bitSlider = select('#bitSlider');

        select('#recordBtn').mousePressed(toggleRecording);
        select('#playSampleBtn').mousePressed(playSample);

        select('#sampleSlider').input(() =>
          select('#sampleValue').html(sampleSlider.value())
        );
        select('#bitSlider').input(() =>
          select('#bitValue').html(bitSlider.value())
        );

        mic = new p5.AudioIn();
        recorder = new p5.SoundRecorder();
        soundFile = new p5.SoundFile();

        recorder.setInput(mic);
      }

      async function toggleRecording() {
        const btn = select('#recordBtn');

        if (!isRecording) {
          await userStartAudio(); // å¿…è¦ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã§éŸ³å£°å…¥åŠ›è¨±å¯ã‚’è¦æ±‚
          mic.start();
          recorder.record(soundFile);
          isRecording = true;
          btn.html('â¹ï¸ éŒ²éŸ³åœæ­¢');
        } else {
          recorder.stop();
          mic.stop();
          isRecording = false;
          btn.html('ğŸ™ï¸ éŒ²éŸ³é–‹å§‹');
          applyEffectsAndPlay(soundFile.buffer);
        }
      }

      // ã‚µãƒ³ãƒ—ãƒ«éŸ³ï¼šçŸ­ã„æ­£å¼¦æ³¢
      function playSample() {
        const ctx = getAudioContext();
        const osc = ctx.createOscillator();
        osc.type = 'sine';
        osc.frequency.value = 440; // A4
        const gain = ctx.createGain();
        gain.gain.value = 0.2;
        osc.connect(gain).connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 1.0);
      }

      function applyEffectsAndPlay(buffer) {
        // ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°é–“éš”ãƒ»ãƒ“ãƒƒãƒˆæ·±åº¦ã‚’å–å¾—
        const sampleStep = int(sampleSlider.value());
        const bitDepth = int(bitSlider.value());

        const numChannels = buffer.numberOfChannels;
        const length = buffer.length;
        const sampleRate = buffer.sampleRate;
        const newBuffer = getAudioContext().createBuffer(numChannels, length, sampleRate);

        for (let ch = 0; ch < numChannels; ch++) {
          const input = buffer.getChannelData(ch);
          const output = newBuffer.getChannelData(ch);

          for (let i = 0; i < length; i++) {
            if (i % sampleStep === 0) {
              // é‡å­åŒ–å‡¦ç†
              const quant = Math.pow(2, bitDepth);
              let val = Math.round(input[i] * (quant / 2)) / (quant / 2);
              output[i] = val;
            } else {
              // å‰ã®å€¤ã‚’ä¿æŒ
              output[i] = output[i - 1] || 0;
            }
          }
        }

        // å†ç”Ÿç”¨ã«å¤‰æ›
        const playback = document.getElementById('playback');
        const ctx = getAudioContext();
        const dest = ctx.createMediaStreamDestination();
        const source
