<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>éŸ³ã®ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ä½“é¨“ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/addons/p5.sound.min.js"></script>
    <style>
      #dropZone {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 20px;
        text-align: center;
        transition: background-color 0.3s;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <main style="text-align:center;">
      <h2>ğŸ™ï¸ éŸ³ã®ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ä½“é¨“</h2>
      <p>éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€æ¨™æœ¬åŒ–ã¨é‡å­åŒ–ã®å½±éŸ¿ã‚’ä½“é¨“ã—ã‚ˆã†ã€‚</p>

      <div id="dropZone" ondragover="return false;">
        ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯<br />
        <label for="fileInput" style="color: blue; text-decoration: underline;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
        <input type="file" id="fileInput" accept="audio/*" style="display: none;" />
      </div>
      <span id="fileStatus" style="color:blue;">éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</span><br /><br />

      <button id="processBtn" disabled>âš™ï¸ å‡¦ç†ï¼†å†ç”Ÿ</button><br /><br />
      
      <label>å…ƒã®éŸ³å£°å†ç”Ÿ:</label>
      <audio id="playback" controls disabled></audio><br /><br />

      <label>æ¨™æœ¬åŒ–é–“éš”ï¼š</label>
      <input type="range" id="sampleSlider" min="1" max="20" value="1" />
      <span id="sampleValue">1</span><br />

      <label>é‡å­åŒ–ãƒ“ãƒƒãƒˆæ•°ï¼š</label>
      <input type="range" id="bitSlider" min="2" max="16" value="8" />
      <span id="bitValue">8</span><br /><br />

      <div id="waveContainer" style="margin-top:20px;">
        <h4>æ³¢å½¢è¡¨ç¤º</h4>
      </div>
    </main>

    <script>
      let recordedBuffer = null; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸéŸ³å£°ã®AudioBuffer
      let waveform = [];

      function setup() {
        let cnv = createCanvas(600, 200);
        cnv.parent("waveContainer");
        background(240);
        textAlign(CENTER);
        text("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨æ³¢å½¢ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™", width / 2, height / 2);

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        select("#processBtn").mousePressed(processAndPlay);

        select("#sampleSlider").input(() =>
          select("#sampleValue").html(select("#sampleSlider").value())
        );
        select("#bitSlider").input(() =>
          select("#bitValue").html(select("#bitSlider").value())
        );
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/ãƒ‰ãƒ­ãƒƒãƒ—ã®ãƒªã‚¹ãƒŠãƒ¼
        const fileInput = select("#fileInput");
        const dropZone = select("#dropZone");

        fileInput.changed(handleFileSelect);
        
        // p5.jsã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ã£ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
        dropZone.dragOver(() => {
            dropZone.style("background-color", "#f0f0ff");
            return false;
        });
        dropZone.dragLeave(() => {
            dropZone.style("background-color", "#fff");
        });
        // drop ã‚¤ãƒ™ãƒ³ãƒˆã¯ p5.js ã® drop() ã‚’ä½¿ã†
        dropZone.drop(handleFileDrop);
      }
      
      // p5.jsã®dropã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã€‚event.dataTransfer.filesã¯p5.Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªã„ãŸã‚ã€
      // ãƒã‚¤ãƒ†ã‚£ãƒ–ã® `event.dataTransfer.files` ã‚’ç›´æ¥ä½¿ã†ã€‚
      function handleFileDrop(event) {
          event.preventDefault(); // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          select("#dropZone").style("background-color", "#fff");
          
          const files = event.dataTransfer.files;
          if (files.length > 0) {
              handleFile(files[0]);
          }
      }

      // <input type="file"> é¸æŠæ™‚ã®å‡¦ç†
      function handleFileSelect() {
          const file = this.elt.files[0];
          if (file) {
              handleFile(file);
          }
      }

      // ãƒ¡ã‚¤ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã¨ãƒ‡ã‚³ãƒ¼ãƒ‰
      async function handleFile(file) {
          if (!file.type.startsWith("audio/")) {
              select("#fileStatus").html("âŒ ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚").style("color", "red");
              return;
          }

          select("#fileStatus").html(`ğŸµ ${file.name} ã‚’èª­ã¿è¾¼ã¿ä¸­...`).style("color", "blue");
          select("#processBtn").attribute("disabled", "true");
          const playback = select("#playback");
          playback.attribute("disabled", "true");
          playback.attribute("src", "");

          try {
              // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ArrayBufferã¨ã—ã¦èª­ã¿è¾¼ã¿ã€Web Audio APIã§ãƒ‡ã‚³ãƒ¼ãƒ‰
              const arrayBuffer = await file.arrayBuffer();
              const ctx = getAudioContext();
              recordedBuffer = await ctx.decodeAudioData(arrayBuffer);

              // ãƒ‡ã‚³ãƒ¼ãƒ‰æˆåŠŸå¾Œã®å‡¦ç†
              const duration = recordedBuffer.duration.toFixed(2);
              select("#fileStatus").html(`âœ… èª­ã¿è¾¼ã¿å®Œäº† (${duration} ç§’)`).style("color", "green");
              
              // <audio>ã‚¿ã‚°ã§å…ƒã®éŸ³å£°ã‚’å†ç”Ÿã§ãã‚‹ã‚ˆã†ã«è¨­å®š
              playback.attribute("src", URL.createObjectURL(file)); 
              playback.removeAttribute("disabled");
              
              drawWaveform(recordedBuffer);
              select("#processBtn").removeAttribute("disabled");

          } catch (e) {
              select("#fileStatus").html(`âŒ ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`).style("color", "red");
              recordedBuffer = null;
              drawWaveform(null);
          }
      }

      function drawWaveform(buffer) {
        if (!buffer) {
          background(255);
          text("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„", width / 2, height / 2);
          return;
        }
        // ... (æ³¢å½¢æç”»ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
        const data = buffer.getChannelData(0);
        waveform = [];
        // å¹…600pxã«åˆã‚ã›ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é–“å¼•ã
        const step = Math.floor(data.length / width); 
        for (let i = 0; i < data.length; i += step) {
          waveform.push(data[i]);
        }
        drawWaveformArray(waveform);
      }

      function drawWaveformArray(arr) {
        // ... (æ³¢å½¢é…åˆ—æç”»ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
        background(255);
        stroke(0);
        noFill();
        beginShape();
        for (let x = 0; x < arr.length; x++) {
          const y = map(arr[x], -1, 1, height, 0);
          vertex(x, y);
        }
        endShape();
      }

      function processAndPlay() {
        if (!recordedBuffer) return alert("éŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");

        const sampleStep = int(select("#sampleSlider").value());
        const bitDepth = int(select("#bitSlider").value());
        const ctx = getAudioContext();

        const numChannels = recordedBuffer.numberOfChannels;
        const length = recordedBuffer.length;
        const sampleRate = recordedBuffer.sampleRate;
        const newBuffer = ctx.createBuffer(numChannels, length, sampleRate);

        for (let ch = 0; ch < numChannels; ch++) {
          const input = recordedBuffer.getChannelData(ch);
          const output = newBuffer.getChannelData(ch);
          
          let lastValue = 0; // ãƒ›ãƒ¼ãƒ«ãƒ‰ç”¨

          for (let i = 0; i < length; i++) {
            if (i % sampleStep === 0) {
              // æ¨™æœ¬åŒ–ç‚¹: é‡å­åŒ–ã‚’é©ç”¨
              const quantLevels = Math.pow(2, bitDepth);
              const scale = quantLevels / 2;
              lastValue = Math.round(input[i] * scale) / scale;
              output[i] = lastValue;

            } else {
              // æ¨™æœ¬åŒ–ç‚¹ä»¥å¤–: ç›´å‰ã®æ¨™æœ¬åŒ–ã®å€¤ã‚’ãƒ›ãƒ¼ãƒ«ãƒ‰
              output[i] = lastValue; 
            }
          }
        }

        drawWaveform(newBuffer);
        
        // Web Audio APIã§å‡¦ç†å¾Œã®éŸ³ã‚’å†ç”Ÿ
        const src = ctx.createBufferSource();
        src.buffer = newBuffer;
        src.connect(ctx.destination);
        src.start(0); 
        
        select("#fileStatus").html("å‡¦ç†å¾Œã®éŸ³ã‚’å†ç”Ÿä¸­...").style("color", "darkorange");
        src.onended = () => {
            // å†ç”Ÿçµ‚äº†å¾Œã€å…ƒã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«æˆ»ã™
            const duration = recordedBuffer.duration.toFixed(2);
            select("#fileStatus").html(`âœ… èª­ã¿è¾¼ã¿å®Œäº† (${duration} ç§’)`).style("color", "green");
        };
      }

      function draw() {}
    </script>
  </body>
</html>
